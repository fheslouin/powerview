---
- name: Grafana User and Dashboard Management
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_url: "{{ lookup('ansible.builtin.env', 'GRAFANA_URL') }}"
    grafana_username: "{{ lookup('ansible.builtin.env', 'GRAFANA_USERNAME') }}"
    grafana_password: "{{ lookup('ansible.builtin.env', 'GRAFANA_PASSWORD') }}"
    grafana_api_token: "{{ lookup('ansible.builtin.env', 'GRAFANA_API_TOKEN') | default('', true) }}"
    influxdb_admin_token: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ADMIN_TOKEN') }}"
    influxdb_username: "{{ lookup('ansible.builtin.env', 'INFLUXDB_USERNAME') }}"
    influxdb_password: "{{ lookup('ansible.builtin.env', 'INFLUXDB_PASSWORD') }}"
    influxdb_org: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ORG') }}"
    influxdb_host: "{{ lookup('ansible.builtin.env', 'INFLUXDB_HOST') }}"

    json_file: "/srv/powerview/dashboard_master.json"
    exported_dashboard_json_file: "/srv/powerview/dashboard_exported.json"
    data_path: "/srv/sftpgo/data"

    # Fichier temporaire pour le dashboard overview
    # IMPORTANT : chemin ABSOLU, pour éviter les problèmes de répertoire courant
    overview_template: "/srv/powerview/grafana-automation/templates/powerview-overview.json"
    overview_json_file: "/srv/powerview/dashboard_overview.json"

    # Headers d'auth pour les appels REST (URI) : on force le token Admin
    grafana_auth_headers: >-
      {{
        {'Authorization': 'Bearer ' ~ grafana_api_token}
      }}

  tasks:
    - name: Validate required variables company_name and campaign_name
      ansible.builtin.assert:
        that:
          - company_name is defined
          - campaign_name is defined
          - company_name | length > 0
          - campaign_name | length > 0
        fail_msg: >
          Les variables 'company_name' et 'campaign_name' doivent être fournies,
          par exemple :
          ansible-playbook grafana-automation/playbooks/create_grafana_resources.yml
          --extra-vars "company_name=company1 campaign_name=campaign1"

    - name: Validate Grafana username/password are set
      ansible.builtin.assert:
        that:
          - grafana_username is defined
          - grafana_password is defined
          - grafana_username | length > 0
          - grafana_password | length > 0
        fail_msg: >
          GRAFANA_USERNAME et GRAFANA_PASSWORD doivent être définis dans l'environnement (.env)
          et correspondre à un compte Grafana avec rôle Admin (pour les modules community.grafana.*).

    - name: Validate Grafana API token is set
      ansible.builtin.assert:
        that:
          - grafana_api_token is defined
          - grafana_api_token | length > 0
        fail_msg: >
          GRAFANA_API_TOKEN doit être défini dans l'environnement (.env) et
          correspondre à un token Grafana avec rôle Admin (utilisé pour les appels REST /api/*).

    - name: Debug Grafana connection settings
      ansible.builtin.debug:
        msg:
          - "GRAFANA_URL={{ grafana_url }}"
          - "GRAFANA_USERNAME={{ grafana_username }}"
          - "GRAFANA_PASSWORD défini: {{ (grafana_password is defined) and (grafana_password | length > 0) }}"
          - "GRAFANA_API_TOKEN défini: {{ grafana_api_token | length > 0 }}"

    - name: Check Grafana health (auth + URL) via token
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/health"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: grafana_health
      failed_when: grafana_health.status != 200

    - name: Check if dashboard created file exists
      stat:
        path: "{{ data_path }}/{{ company_name }}/{{ campaign_name }}/.dashboard.created"
      register: dashboard_created

    # ------------------------------------------------------------------
    # Création / récupération de la team Grafana
    # ------------------------------------------------------------------

    - name: Try to create Grafana team (idempotent via status_code 200/409)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          name: "{{ company_name }}"
        status_code: [200, 409]
        validate_certs: false
      register: created_team
      when: not dashboard_created.stat.exists

    - name: Debug Create Grafana Team response
      ansible.builtin.debug:
        var: created_team
      when: not dashboard_created.stat.exists

    - name: When team already exists (409), search team by name to get id
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams/search?name={{ company_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: team_search
      when:
        - not dashboard_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409

    - name: Fail if team not found after 409 conflict
      ansible.builtin.fail:
        msg: >
          La team Grafana '{{ company_name }}' existe déjà (409) mais n'a pas pu être retrouvée
          via /api/teams/search. Vérifie manuellement dans Grafana.
      when:
        - not dashboard_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409
        - (team_search.json.teams | default([]) | length) == 0

    - name: Set grafana_team_id when team was just created (status 200)
      ansible.builtin.set_fact:
        grafana_team_id: "{{ created_team.json.teamId }}"
      when:
        - not dashboard_created.stat.exists
        - created_team.status is defined
        - created_team.status == 200

    - name: Set grafana_team_id when team already existed (status 409)
      ansible.builtin.set_fact:
        grafana_team_id: "{{ (team_search.json.teams | first).id }}"
      when:
        - not dashboard_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409
        - (team_search.json.teams | default([]) | length) > 0

    - name: Debug team id
      ansible.builtin.debug:
        msg:
          - "Team utilisée pour company_name='{{ company_name }}'"
          - "team_id={{ grafana_team_id }}"
      when: not dashboard_created.stat.exists

    # ------------------------------------------------------------------
    # Création du bucket, folder, datasource, dashboard
    # ------------------------------------------------------------------

    - name: Ensure InfluxDB bucket exists for company (idempotent, via Python parser)
      ansible.builtin.debug:
        msg: >
          Le bucket InfluxDB '{{ company_name }}' doit déjà exister
          (créé automatiquement par tsv_parser.py via create_bucket_if_not_exists).

    - name: Ensure manage_influx_tokens.py is present
      ansible.builtin.stat:
        path: "/srv/powerview/manage_influx_tokens.py"
      register: manage_tokens_script
      when: not dashboard_created.stat.exists

    - name: Fail if manage_influx_tokens.py is missing
      ansible.builtin.fail:
        msg: "Le script /srv/powerview/manage_influx_tokens.py est introuvable. Impossible de gérer le token InfluxDB dédié au bucket {{ company_name }}."
      when:
        - not dashboard_created.stat.exists
        - not manage_tokens_script.stat.exists

    - name: Create or get dedicated InfluxDB token for bucket
      ansible.builtin.command: >
        python3 /srv/powerview/manage_influx_tokens.py
        --bucket {{ company_name }}
      register: bucket_token_cmd
      changed_when: false
      when: not dashboard_created.stat.exists

    - name: Set fact for bucket token
      ansible.builtin.set_fact:
        influxdb_bucket_token: "{{ bucket_token_cmd.stdout | trim }}"
      when: not dashboard_created.stat.exists

    - name: Debug bucket token (masqué)
      ansible.builtin.debug:
        msg: "Token dédié récupéré pour le bucket {{ company_name }} (longueur={{ influxdb_bucket_token | length }})"
        verbosity: 1
      no_log: true
      when: not dashboard_created.stat.exists

    - name: Create Grafana folder for team
      community.grafana.grafana_folder:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        title: "{{ company_name }}"
        state: present
        validate_certs: false
      register: created_folder
      when: not dashboard_created.stat.exists

    - name: Create InfluxDB datasource (plugin influxdb-adecwatts-datasource)
      community.grafana.grafana_datasource:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "influxdb_{{ company_name }}"
        ds_type: influxdb
        ds_url: "{{ influxdb_host | default('http://influxdb:8086') }}"
        basic_auth_user: "{{ influxdb_username }}"
        basic_auth_password: "{{ influxdb_password }}"
        additional_json_data:
          version: "Flux"
          organization: "{{ influxdb_org }}"
          defaultBucket: "{{ company_name }}"
          tlsSkipVerify: false
        additional_secure_json_data:
          token: "{{ influxdb_bucket_token }}"
        state: present
        validate_certs: false
      register: created_datasource
      when: not dashboard_created.stat.exists

    - name: Export master dashboard as JSON file
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: export
        path: "{{ exported_dashboard_json_file }}"
        uid: "adq2j6z"
        validate_certs: false
      register: exported_dashboard
      when: not dashboard_created.stat.exists

    - name: Modify Grafana dashboard JSON
      ansible.builtin.shell: |
        set -euo pipefail

        if ! command -v jq >/dev/null 2>&1; then
          echo "jq n'est pas installé sur ce système (requis pour modifier le dashboard JSON)" >&2
          exit 1
        fi

        jq '
          del(.dashboard.version)
          | del(.dashboard.id)
          | del(.dashboard.uid)
          | del(.meta)
          | .dashboard.title = "{{ campaign_name }}"
          | walk(
              if type == "object"
                 and has("type")
                 and has("uid")
                 and .type == "influxdb"
              then
                .type = "influxdb-adecwatts-datasource"
                | .uid = "{{ created_datasource.datasource.uid }}"
              else
                .
              end
            )
        ' "{{ exported_dashboard_json_file }}" > "{{ json_file }}"
      args:
        executable: /bin/bash
      when: not dashboard_created.stat.exists

    - name: Debug generated dashboard JSON (first 40 lines)
      ansible.builtin.shell: |
        set -euo pipefail
        head -n 40 "{{ json_file }}" || true
      args:
        executable: /bin/bash
      register: debug_dashboard_json
      changed_when: false
      when: not dashboard_created.stat.exists

    - name: Show generated dashboard JSON snippet
      ansible.builtin.debug:
        var: debug_dashboard_json.stdout
      when: not dashboard_created.stat.exists

    - name: Import dashboard from templated JSON
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: present
        path: "{{ json_file }}"
        folder: "{{ company_name }}"
        uid: '{{ lookup("pipe", "uuidgen") }}'
        overwrite: true
        validate_certs: false
      register: imported_dashboard
      when: not dashboard_created.stat.exists

    # ------------------------------------------------------------------
    # Dashboard OVERVIEW par client (à partir du template powerview-overview.json)
    # ------------------------------------------------------------------

    - name: Build overview dashboard JSON from template
      ansible.builtin.shell: |
        set -euo pipefail

        if ! command -v jq >/dev/null 2>&1; then
          echo "jq n'est pas installé sur ce système (requis pour modifier le dashboard overview)" >&2
          exit 1
        fi

        jq '
          .title = "Overview {{ company_name }}"
          | walk(
              if type == "object"
                 and has("datasource")
                 and .datasource.type == "influxdb-adecwatts-datasource"
              then
                .datasource.uid = "{{ created_datasource.datasource.uid }}"
              else
                .
              end
            )
          | walk(
              if type == "object"
                 and has("query")
                 and (.query | type == "string")
              then
                .query |= sub("from\\(bucket:\\\"company1\\\"\\)"; "from(bucket:\\\"{{ company_name }}\\\")")
              else
                .
              end
            )
        ' "{{ overview_template }}" > "{{ overview_json_file }}"
      args:
        executable: /bin/bash
      when: not dashboard_created.stat.exists

    - name: Import overview dashboard for company
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: present
        path: "{{ overview_json_file }}"
        folder: "{{ company_name }}"
        uid: '{{ lookup("pipe", "uuidgen") }}'
        overwrite: true
        validate_certs: false
      register: imported_overview
      when: not dashboard_created.stat.exists

    # ------------------------------------------------------------------
    # Permissions via team (créée ou existante)
    # ------------------------------------------------------------------

    - name: Set dashboard permissions for team (viewer role)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/dashboards/uid/{{ imported_dashboard.uid }}/permissions"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          items:
            - teamId: "{{ grafana_team_id }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when:
        - not dashboard_created.stat.exists

    - name: Set folder permissions for team
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/folders/{{ created_folder.folder.uid }}/permissions"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          items:
            - teamId: "{{ grafana_team_id }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when: not dashboard_created.stat.exists

    # ------------------------------------------------------------------
    # Nettoyage + marqueur .dashboard.created
    # ------------------------------------------------------------------

    - name: Clean up temporary dashboard file
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ json_file }}"
        - "{{ exported_dashboard_json_file }}"
        - "{{ overview_json_file }}"
      when: not dashboard_created.stat.exists

    - name: Touch a file -> Dashboard created
      ansible.builtin.file:
        path: "{{ data_path }}/{{ company_name }}/{{ campaign_name }}/.dashboard.created"
        state: touch
      when: not dashboard_created.stat.exists

    - name: Display user credentials
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Grafana Resources Created Successfully!"
          - "============================================"
          - "Team: {{ company_name }} (id={{ grafana_team_id }})"
          - "Datasource: influxdb_{{ company_name }} (type=plugin influxdb-adecwatts-datasource, token dédié au bucket '{{ company_name }}' via manage_influx_tokens.py)"
          - "Dashboard: {{ campaign_name }}"
          - "Overview dashboard: Overview {{ company_name }}"
          - "Folder: {{ company_name }}"
