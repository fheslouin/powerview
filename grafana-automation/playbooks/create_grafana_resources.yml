---
- name: Grafana User and Dashboard Management
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_url: "{{ lookup('ansible.builtin.env', 'GRAFANA_URL') }}"
    grafana_username: "{{ lookup('ansible.builtin.env', 'GRAFANA_USERNAME') }}"
    grafana_password: "{{ lookup('ansible.builtin.env', 'GRAFANA_PASSWORD') }}"
    grafana_api_token: "{{ lookup('ansible.builtin.env', 'GRAFANA_API_TOKEN') | default('', true) }}"
    influxdb_admin_token: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ADMIN_TOKEN') }}"
    influxdb_username: "{{ lookup('ansible.builtin.env', 'INFLUXDB_USERNAME') }}"
    influxdb_password: "{{ lookup('ansible.builtin.env', 'INFLUXDB_PASSWORD') }}"
    influxdb_org: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ORG') }}"
    influxdb_host: "{{ lookup('ansible.builtin.env', 'INFLUXDB_HOST') }}"

    json_file: "/srv/powerview/dashboard_master.json"
    exported_dashboard_json_file: "/srv/powerview/dashboard_exported.json"
    data_path: "/srv/sftpgo/data"

    # Headers d'auth Grafana si on utilise un token API
    grafana_auth_headers: >-
      {{
        {} if (grafana_api_token | length == 0)
        else {'Authorization': 'Bearer ' ~ grafana_api_token}
      }}

  tasks:
    - name: Validate required variables company_name and campaign_name
      ansible.builtin.assert:
        that:
          - company_name is defined
          - campaign_name is defined
          - company_name | length > 0
          - campaign_name | length > 0
        fail_msg: >
          Les variables 'company_name' et 'campaign_name' doivent être fournies,
          par exemple :
          ansible-playbook grafana-automation/playbooks/create_grafana_resources.yml
          --extra-vars "company_name=company1 campaign_name=campaign1"

    - name: Debug Grafana connection settings
      ansible.builtin.debug:
        msg:
          - "GRAFANA_URL={{ grafana_url }}"
          - "GRAFANA_USERNAME={{ grafana_username }}"
          - "GRAFANA_PASSWORD est défini: {{ (grafana_password is defined) and (grafana_password | length > 0) }}"
          - "GRAFANA_API_TOKEN est défini: {{ grafana_api_token | length > 0 }}"

    - name: Check Grafana health (auth + URL)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/health"
        method: GET
        url_username: "{{ (grafana_api_token | length == 0) | ternary(grafana_username, omit) }}"
        url_password: "{{ (grafana_api_token | length == 0) | ternary(grafana_password, omit) }}"
        headers: "{{ grafana_auth_headers }}"
        force_basic_auth: "{{ (grafana_api_token | length == 0) | ternary(true, false) }}"
        status_code: 200
        validate_certs: false
      register: grafana_health
      failed_when: grafana_health.status != 200

    - name: Check if dashboard created file exists
      stat:
        path: "{{ data_path }}/{{ company_name }}/{{ campaign_name }}/.dashboard.created"
      register: dashboard_created

    - name: Create Grafana Team
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams"
        method: POST
        url_username: "{{ (grafana_api_token | length == 0) | ternary(grafana_username, omit) }}"
        url_password: "{{ (grafana_api_token | length == 0) | ternary(grafana_password, omit) }}"
        headers: "{{ grafana_auth_headers }}"
        force_basic_auth: "{{ (grafana_api_token | length == 0) | ternary(true, false) }}"
        body_format: json
        body:
          name: "{{ company_name }}"
        status_code: [200, 409]
        validate_certs: false
      register: created_team
      when: not dashboard_created.stat.exists

    - name: Create Grafana folder for team
      community.grafana.grafana_folder:
        url: "{{ grafana_url }}"
        url_username: "{{ (grafana_api_token | length == 0) | ternary(grafana_username, omit) }}"
        url_password: "{{ (grafana_api_token | length == 0) | ternary(grafana_password, omit) }}"
        # Le module community.grafana ne supporte pas encore les headers custom,
        # donc pour l'instant il nécessite login/mot de passe.
        title: "{{ company_name }}"
        state: present
        validate_certs: false
      register: created_folder
      when:
        - not dashboard_created.stat.exists
        - (created_team.status | default(200)) != 409

    - name: Ensure InfluxDB bucket exists for company (idempotent, via Python parser)
      ansible.builtin.debug:
        msg: >
          Le bucket InfluxDB '{{ company_name }}' doit déjà exister
          (créé automatiquement par tsv_parser.py via create_bucket_if_not_exists).

    # ------------------------------------------------------------------
    # Gestion du token InfluxDB dédié au bucket via manage_influx_tokens.py
    # ------------------------------------------------------------------

    - name: Ensure manage_influx_tokens.py is present
      ansible.builtin.stat:
        path: "/srv/powerview/manage_influx_tokens.py"
      register: manage_tokens_script
      when: not dashboard_created.stat.exists

    - name: Fail if manage_influx_tokens.py is missing
      ansible.builtin.fail:
        msg: "Le script /srv/powerview/manage_influx_tokens.py est introuvable. Impossible de gérer le token InfluxDB dédié au bucket {{ company_name }}."
      when:
        - not dashboard_created.stat.exists
        - not manage_tokens_script.stat.exists

    - name: Create or get dedicated InfluxDB token for bucket
      ansible.builtin.command: >
        python3 /srv/powerview/manage_influx_tokens.py
        --bucket {{ company_name }}
      register: bucket_token_cmd
      changed_when: false
      when: not dashboard_created.stat.exists

    - name: Set fact for bucket token
      ansible.builtin.set_fact:
        influxdb_bucket_token: "{{ bucket_token_cmd.stdout | trim }}"
      when: not dashboard_created.stat.exists

    - name: Debug bucket token (masqué)
      ansible.builtin.debug:
        msg: "Token dédié récupéré pour le bucket {{ company_name }} (longueur={{ influxdb_bucket_token | length }})"
        verbosity: 1
      no_log: true
      when: not dashboard_created.stat.exists

    - name: Create InfluxDB datasource (plugin influxdb-adecwatts-datasource)
      community.grafana.grafana_datasource:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "influxdb_{{ company_name }}"
        ds_type: influxdb-adecwatts-datasource
        ds_url: "{{ influxdb_host | default('http://influxdb:8086') }}"
        basic_auth_user: "{{ influxdb_username }}"
        basic_auth_password: "{{ influxdb_password }}"
        additional_json_data:
          version: "Flux"
          organization: "{{ influxdb_org }}"
          defaultBucket: "{{ company_name }}"
          tlsSkipVerify: false
        additional_secure_json_data:
          token: "{{ influxdb_bucket_token }}"
        state: present
        validate_certs: false
      register: created_datasource
      when: not dashboard_created.stat.exists

    - name: Export master dashboard as JSON file
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: export
        path: "{{ exported_dashboard_json_file }}"
        uid: "adq2j6z"
        validate_certs: false
      register: exported_dashboard
      when: not dashboard_created.stat.exists

    - name: Modify Grafana dashboard JSON
      ansible.builtin.shell: |
        jq 'del(.dashboard.version)
            | del(.dashboard.id)
            | del(.dashboard.uid)
            | del(.meta)
            | .dashboard.title = "{{ campaign_name }}"
            # Met à jour type + uid pour toutes les datasources Influx
            | (..|objects
               | select(has("type") and has("uid") and .type=="influxdb")
               | .type = "influxdb-adecwatts-datasource"
               | .uid = "{{ created_datasource.datasource.uid }}" )' \
           "{{ exported_dashboard_json_file }}" > "{{ json_file }}"
      args:
        executable: /bin/bash
      when: not dashboard_created.stat.exists

    - name: Import dashboard from templated JSON
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: present
        path: "{{ json_file }}"
        folder: "{{ company_name }}"
        uid: '{{ lookup("pipe", "uuidgen") }}'
        overwrite: true
        validate_certs: false
      register: imported_dashboard
      when: not dashboard_created.stat.exists

    - name: Set dashboard permissions for team (viewer role)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/dashboards/uid/{{ imported_dashboard.uid }}/permissions"
        method: POST
        url_username: "{{ (grafana_api_token | length == 0) | ternary(grafana_username, omit) }}"
        url_password: "{{ (grafana_api_token | length == 0) | ternary(grafana_password, omit) }}"
        headers: "{{ grafana_auth_headers }}"
        force_basic_auth: "{{ (grafana_api_token | length == 0) | ternary(true, false) }}"
        body_format: json
        body:
          items:
            - teamId: "{{ created_team.json.teamId }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when:
        - not dashboard_created.stat.exists
        - (created_team.status | default(200)) != 409

    - name: Set folder permissions for team
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/folders/{{ created_folder.folder.uid }}/permissions"
        method: POST
        url_username: "{{ (grafana_api_token | length == 0) | ternary(grafana_username, omit) }}"
        url_password: "{{ (grafana_api_token | length == 0) | ternary(grafana_password, omit) }}"
        headers: "{{ grafana_auth_headers }}"
        force_basic_auth: "{{ (grafana_api_token | length == 0) | ternary(true, false) }}"
        body_format: json
        body:
          items:
            - teamId: "{{ created_team.json.teamId }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when:
        - not dashboard_created.stat.exists
        - (created_team.status | default(200)) == 409

    - name: Clean up temporary dashboard file
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ json_file }}"
        - "{{ exported_dashboard_json_file }}"
      when: not dashboard_created.stat.exists

    - name: Touch a file -> Dashboard created
      ansible.builtin.file:
        path: "{{ data_path }}/{{ company_name }}/{{ campaign_name }}/.dashboard.created"
        state: touch
      when: not dashboard_created.stat.exists

    - name: Display user credentials
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Grafana Resources Created Successfully!"
          - "============================================"
          - "Team: {{ company_name }}"
          - "Datasource: influxdb_{{ company_name }} (type=plugin influxdb-adecwatts-datasource, token dédié au bucket '{{ company_name }}' via manage_influx_tokens.py)"
          - "Dashboard: {{ campaign_name }}"
          - "Folder: {{ company_name }}"
