---
- name: Grafana User and Dashboard Management
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_url: "{{ lookup('ansible.builtin.env', 'GRAFANA_URL') }}"
    grafana_username: "{{ lookup('ansible.builtin.env', 'GRAFANA_USERNAME') }}"
    grafana_password: "{{ lookup('ansible.builtin.env', 'GRAFANA_PASSWORD') }}"
    grafana_api_token: "{{ lookup('ansible.builtin.env', 'GRAFANA_API_TOKEN') | default('', true) }}"
    influxdb_admin_token: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ADMIN_TOKEN') }}"
    influxdb_username: "{{ lookup('ansible.builtin.env', 'INFLUXDB_USERNAME') }}"
    influxdb_password: "{{ lookup('ansible.builtin.env', 'INFLUXDB_PASSWORD') }}"
    influxdb_org: "{{ lookup('ansible.builtin.env', 'INFLUXDB_ORG') }}"
    influxdb_host: "{{ lookup('ansible.builtin.env', 'INFLUXDB_HOST') }}"

    data_path: "/srv/sftpgo/data"

    # Template Jinja pour le dashboard de company
    dashboard_template: "{{ playbook_dir }}/../templates/dashboard.json.j2"
    campaign_dashboard_json: "/srv/powerview/dashboard_campaign.json"

    # UID déterministe pour l'idempotence du dashboard (un par company)
    campaign_dashboard_uid: "powerview_{{ company_name }}"

    # Variables pour l'utilisateur "admin" de la team (surchageables via --extra-vars)
    company_user_login: "{{ company_user_login_override | default('user_' ~ company_name, true) }}"
    company_user_email: "{{ company_user_email_override | default('user_' ~ company_name ~ '@example.com', true) }}"
    company_user_password: "{{ company_user_password_override | default('ChangeMe123!', true) }}"

    # Headers d'auth pour les appels REST (URI) : on force le token Admin
    grafana_auth_headers: >-
      {{
        {'Authorization': 'Bearer ' ~ grafana_api_token}
      }}

  tasks:
    - name: Validate required variable company_name
      ansible.builtin.assert:
        that:
          - company_name is defined
          - company_name | length > 0
        fail_msg: >
          La variable 'company_name' doit être fournie, par exemple :
          ansible-playbook grafana-automation/playbooks/create_grafana_resources.yml
          --extra-vars "company_name=company1"

    - name: Validate Grafana username/password are set
      ansible.builtin.assert:
        that:
          - grafana_username is defined
          - grafana_password is defined
          - grafana_username | length > 0
          - grafana_password | length > 0
        fail_msg: >
          GRAFANA_USERNAME et GRAFANA_PASSWORD doivent être définis dans l'environnement (.env)
          et correspondre à un compte Grafana avec rôle Admin (pour les modules community.grafana.*).

    - name: Validate Grafana API token is set
      ansible.builtin.assert:
        that:
          - grafana_api_token is defined
          - grafana_api_token | length > 0
        fail_msg: >
          GRAFANA_API_TOKEN doit être défini dans l'environnement (.env) et
          correspondre à un token Grafana avec rôle Admin (utilisé pour les appels REST /api/*).

    - name: Debug Grafana connection settings
      ansible.builtin.debug:
        msg:
          - "GRAFANA_URL={{ grafana_url }}"
          - "GRAFANA_USERNAME={{ grafana_username }}"
          - "GRAFANA_PASSWORD défini: {{ (grafana_password is defined) and (grafana_password | length > 0) }}"
          - "GRAFANA_API_TOKEN défini: {{ grafana_api_token | length > 0 }}"

    - name: Check Grafana health (auth + URL) via token
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/health"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: grafana_health
      failed_when: grafana_health.status != 200

    - name: Check if company created file exists
      ansible.builtin.stat:
        path: "{{ data_path }}/{{ company_name }}/.company.created"
      register: company_created

    # ------------------------------------------------------------------
    # Création / récupération de la team Grafana
    # ------------------------------------------------------------------

    - name: Try to create Grafana team (idempotent via status_code 200/409)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          name: "{{ company_name }}"
        status_code: [200, 409]
        validate_certs: false
      register: created_team
      when: not company_created.stat.exists

    - name: Debug Create Grafana Team response
      ansible.builtin.debug:
        var: created_team
      when: not company_created.stat.exists

    - name: When team already exists (409), search team by name to get id
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams/search?name={{ company_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: team_search
      when:
        - not company_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409

    - name: Fail if team not found after 409 conflict
      ansible.builtin.fail:
        msg: >
          La team Grafana '{{ company_name }}' existe déjà (409) mais n'a pas pu être retrouvée
          via /api/teams/search. Vérifie manuellement dans Grafana.
      when:
        - not company_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409
        - (team_search.json.teams | default([]) | length) == 0

    - name: Set grafana_team_id when team was just created (status 200)
      ansible.builtin.set_fact:
        grafana_team_id: "{{ created_team.json.teamId }}"
      when:
        - not company_created.stat.exists
        - created_team.status is defined
        - created_team.status == 200

    - name: Set grafana_team_id when team already existed (status 409)
      ansible.builtin.set_fact:
        grafana_team_id: "{{ (team_search.json.teams | first).id }}"
      when:
        - not company_created.stat.exists
        - created_team.status is defined
        - created_team.status == 409
        - (team_search.json.teams | default([]) | length) > 0

    - name: Debug team id
      ansible.builtin.debug:
        msg:
          - "Team utilisée pour company_name='{{ company_name }}'"
          - "team_id={{ grafana_team_id }}"
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Création d'un utilisateur dédié à la team (non admin global)
    # ------------------------------------------------------------------

    - name: Créer / assurer l'existence de l'utilisateur Grafana pour la company
      community.grafana.grafana_user:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "{{ company_name }} Default"
        login: "{{ company_user_login }}"
        email: "{{ company_user_email }}"
        password: "{{ company_user_password }}"
        is_admin: false
        state: present
        validate_certs: false
      register: company_user
      when: not company_created.stat.exists

    - name: Ajouter l'utilisateur à la team (membre de la team uniquement)
      community.grafana.grafana_team:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "{{ company_name }}"
        email: "{{ company_user_email }}"
        members:
          - "{{ company_user_login }}"
        state: present
        validate_certs: false
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Création du bucket, folder, datasource
    # ------------------------------------------------------------------

    - name: Ensure InfluxDB bucket exists for company (idempotent, via Python parser)
      ansible.builtin.debug:
        msg: >
          Le bucket InfluxDB '{{ company_name }}' doit déjà exister
          (créé automatiquement par tsv_parser.py via create_bucket_if_not_exists).

    - name: Ensure manage_influx_tokens.py is present
      ansible.builtin.stat:
        path: "/srv/powerview/manage_influx_tokens.py"
      register: manage_tokens_script
      when: not company_created.stat.exists

    - name: Fail if manage_influx_tokens.py is missing
      ansible.builtin.fail:
        msg: "Le script /srv/powerview/manage_influx_tokens.py est introuvable. Impossible de gérer le token InfluxDB dédié au bucket {{ company_name }}."
      when:
        - not company_created.stat.exists
        - not manage_tokens_script.stat.exists

    - name: Debug Influx env before managing bucket token
      ansible.builtin.debug:
        msg:
          - "INFLUXDB_HOST={{ influxdb_host }}"
          - "INFLUXDB_ORG={{ influxdb_org }}"
          - "INFLUXDB_ADMIN_TOKEN défini: {{ (influxdb_admin_token is defined) and (influxdb_admin_token | length > 0) }}"
      when: not company_created.stat.exists

    - name: Create or get dedicated InfluxDB token for bucket
      ansible.builtin.command: >
        python3 /srv/powerview/manage_influx_tokens.py
        --bucket {{ company_name }}
      register: bucket_token_cmd
      changed_when: false
      when: not company_created.stat.exists

    - name: Set fact for bucket token
      ansible.builtin.set_fact:
        influxdb_bucket_token: "{{ bucket_token_cmd.stdout | trim }}"
      when: not company_created.stat.exists

    - name: Debug bucket token (masqué)
      ansible.builtin.debug:
        msg: "Token dédié récupéré pour le bucket {{ company_name }} (longueur={{ influxdb_bucket_token | length }})"
        verbosity: 1
      no_log: true
      when: not company_created.stat.exists

    - name: Create Grafana folder for team
      community.grafana.grafana_folder:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        title: "{{ company_name }}"
        state: present
        validate_certs: false
      register: created_folder
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Datasource InfluxDB : ne pas la recréer si elle existe déjà
    # ------------------------------------------------------------------

    - name: Check if InfluxDB datasource already exists
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/name/influxdb_{{ company_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: [200, 404]
        validate_certs: false
      register: existing_ds
      when: not company_created.stat.exists

    - name: Create InfluxDB datasource (créée comme influxdb, patchée ensuite en plugin custom)
      community.grafana.grafana_datasource:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "influxdb_{{ company_name }}"
        ds_type: influxdb
        ds_url: "{{ influxdb_url | default('http://influxdb:8086') }}"
        access: proxy
        is_default: false
        additional_json_data:
          version: "Flux"
          organization: "{{ influxdb_org }}"
          defaultBucket: "{{ company_name }}"
          tlsSkipVerify: true
          httpMode: "POST"
          httpHeaderName1: "Authorization"
          readOnly: true
          channelsList: []
          triphasicList: []
          virtualSeries: []
          seriesConfigApiUrl: "/api/datasources/proxy/25"
          clientId: "{{ company_name }}_{{ company_user_login }}"
        additional_secure_json_data:
          httpHeaderValue1: "Token {{ influxdb_bucket_token }}"
          token: "{{ influxdb_bucket_token }}"
        state: present
        validate_certs: false
      register: created_datasource
      when:
        - not company_created.stat.exists
        - existing_ds.status == 404

    - name: Set fact for datasource when it already exists
      ansible.builtin.set_fact:
        created_datasource:
          datasource:
            uid: "{{ existing_ds.json.uid }}"
            id: "{{ existing_ds.json.id }}"
            jsonData: "{{ existing_ds.json.jsonData | default({}) }}"
      when:
        - not company_created.stat.exists
        - existing_ds.status == 200

    - name: Get created datasource by name
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/name/influxdb_{{ company_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: ds_get
      when: not company_created.stat.exists

    - name: Compute datasource_client_id fact
      ansible.builtin.set_fact:
        datasource_client_id: >-
          {{
            (ds_get.json.jsonData.clientId
             if (ds_get.json.jsonData is defined and 'clientId' in ds_get.json.jsonData)
             else (company_name ~ '_' ~ company_user_login))
          }}
      when: not company_created.stat.exists

    - name: Patch datasource to use custom plugin type et forcer les Custom HTTP Headers
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/{{ ds_get.json.id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ grafana_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body: >-
          {{
            ds_get.json
            | combine(
                {
                  'type': 'influxdb-adecwatts-datasource',
                  'jsonData': (
                    (ds_get.json.jsonData | default({}))
                    | combine(
                        {
                          'httpHeaderName1': 'Authorization',
                          'version': 'Flux',
                          'organization': influxdb_org,
                          'defaultBucket': company_name,
                          'tlsSkipVerify': true,
                          'httpMode': 'POST',
                          'readOnly': true,
                          'channelsList': [],
                          'triphasicList': [],
                          'virtualSeries': [],
                          'seriesConfigApiUrl': '/api/datasources/proxy/25',
                          'clientId': datasource_client_id
                        },
                        recursive=True
                      )
                  ),
                  'secureJsonData': (
                    (ds_get.json.secureJsonData | default({}))
                    | combine(
                        {
                          'httpHeaderValue1': 'Token ' ~ influxdb_bucket_token,
                          'token': influxdb_bucket_token
                        },
                        recursive=True
                      )
                  )
                },
                recursive=True
              )
          }}
        status_code: 200
        validate_certs: false
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Dashboard via template Jinja (UN SEUL dashboard par company)
    # ------------------------------------------------------------------

    - name: Ensure dashboard template exists
      ansible.builtin.stat:
        path: "{{ dashboard_template }}"
      register: dashboard_template_stat
      when: not company_created.stat.exists

    - name: Fail if dashboard template is missing
      ansible.builtin.fail:
        msg: >
          Le template de dashboard est introuvable :
          {{ dashboard_template }}
          Assure-toi que le fichier 'grafana-automation/templates/dashboard.json.j2'
          est bien présent sur le serveur.
      when:
        - not company_created.stat.exists
        - not dashboard_template_stat.stat.exists

    - name: Render company dashboard JSON from template
      ansible.builtin.template:
        src: "{{ dashboard_template }}"
        dest: "{{ campaign_dashboard_json }}"
        mode: "0644"
      vars:
        company_name: "{{ company_name }}"
        datasource_uid: "{{ created_datasource.datasource.uid }}"
        datasource_id: "{{ created_datasource.datasource.id }}"
        datasource_client_id: "{{ datasource_client_id }}"
      when:
        - not company_created.stat.exists
        - dashboard_template_stat.stat.exists

    - name: Import company dashboard (idempotent via UID fixe)
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: present
        path: "{{ campaign_dashboard_json }}"
        folder: "{{ company_name }}"
        uid: "{{ campaign_dashboard_uid }}"
        overwrite: true
        validate_certs: false
      register: imported_dashboard
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Permissions via team (créée ou existante)
    # ------------------------------------------------------------------

    - name: Set dashboard permissions for team (viewer role)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/dashboards/uid/{{ imported_dashboard.uid }}/permissions"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          items:
            - teamId: "{{ grafana_team_id }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when:
        - not company_created.stat.exists

    - name: Set folder permissions for team
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/folders/{{ created_folder.folder.uid }}/permissions"
        method: POST
        headers: "{{ grafana_auth_headers }}"
        body_format: json
        body:
          items:
            - teamId: "{{ grafana_team_id }}"
              permission: 1
        status_code: 200
        validate_certs: false
      when: not company_created.stat.exists

    # ------------------------------------------------------------------
    # Nettoyage + marqueur .company.created
    # ------------------------------------------------------------------

    - name: Clean up temporary dashboard file
      ansible.builtin.file:
        path: "{{ campaign_dashboard_json }}"
        state: absent
      when: not company_created.stat.exists

    - name: Ensure company directory exists
      ansible.builtin.file:
        path: "{{ data_path }}/{{ company_name }}"
        state: directory
        mode: "0755"
      become: true
      become_user: sftpgo
      when: not company_created.stat.exists

    - name: Touch a file -> Company created
      ansible.builtin.file:
        path: "{{ data_path }}/{{ company_name }}/.company.created"
        state: touch
      become: true
      become_user: sftpgo
      when: not company_created.stat.exists

    - name: Display user credentials
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Grafana Resources Created Successfully!"
          - "============================================"
          - "Team: {{ company_name }} (id={{ grafana_team_id }})"
          - "Datasource: influxdb_{{ company_name }} (type=plugin influxdb-adecwatts-datasource, token dédié au bucket '{{ company_name }}' via manage_influx_tokens.py)"
          - "Dashboard (company): uid={{ campaign_dashboard_uid }}"
          - "Folder: {{ company_name }}"
          - "User (team member): login='{{ company_user_login }}', email='{{ company_user_email }}'"
      when: not company_created.stat.exists
