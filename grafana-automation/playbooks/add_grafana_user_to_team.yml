---
- name: Add a Grafana user to an existing team
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_url: "{{ lookup('ansible.builtin.env', 'GRAFANA_URL') }}"
    grafana_username: "{{ lookup('ansible.builtin.env', 'GRAFANA_USERNAME') }}"
    grafana_password: "{{ lookup('ansible.builtin.env', 'GRAFANA_PASSWORD') }}"
    grafana_api_token: "{{ lookup('ansible.builtin.env', 'GRAFANA_API_TOKEN') | default('', true) }}"

    # Nom de la team Grafana existante (ex: company1), à passer via --extra-vars

    # Par défaut, on considère que la team correspond à la company.
    company_name: "{{ company_name_override | default(team_name, true) }}"

    # Template Jinja pour le dashboard de company
    dashboard_template: "{{ playbook_dir }}/../templates/dashboard.json.j2"
    campaign_dashboard_json: "/srv/powerview/dashboard_campaign.json"

    # UID déterministe pour l'idempotence du dashboard (un par user)
    campaign_dashboard_uid: "powerview_{{ company_name }}_{{ user_login }}"

    # user_login / user_email / user_password peuvent être surchargés via --extra-vars
    user_login: "{{ user_login_override | default('user_' ~ team_name, true) }}"
    user_email: "{{ user_email_override | default(team_name ~ '@example.com', true) }}"
    user_password: "{{ user_password_override | default('ChangeMe123!', true) }}"

    grafana_auth_headers: >-
      {{
        {'Authorization': 'Bearer ' ~ grafana_api_token}
      }}

  tasks:
    - name: Validate required variable team_name
      ansible.builtin.assert:
        that:
          - team_name is defined
          - team_name | length > 0
        fail_msg: >
          La variable 'team_name' doit être fournie, par exemple :
          ansible-playbook grafana-automation/playbooks/add_grafana_user_to_team.yml
          --extra-vars "team_name=company1"

    - name: Validate Grafana credentials
      ansible.builtin.assert:
        that:
          - grafana_username is defined
          - grafana_password is defined
          - grafana_username | length > 0
          - grafana_password | length > 0
          - grafana_api_token is defined
          - grafana_api_token | length > 0
        fail_msg: >
          GRAFANA_USERNAME, GRAFANA_PASSWORD et GRAFANA_API_TOKEN doivent être définis
          dans l'environnement (.env) et correspondre à un compte / token Admin.

    - name: Check Grafana health
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/health"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: grafana_health
      failed_when: grafana_health.status != 200

    # ------------------------------------------------------------------
    # Récupérer la team existante
    # ------------------------------------------------------------------

    - name: Search existing team by name
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams/search?name={{ team_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: team_search

    - name: Fail if team not found
      ansible.builtin.fail:
        msg: >
          La team Grafana '{{ team_name }}' est introuvable via /api/teams/search.
          Vérifie le nom dans Grafana.
      when: (team_search.json.teams | default([]) | length) == 0

    - name: Set grafana_team_id fact
      ansible.builtin.set_fact:
        grafana_team_id: "{{ (team_search.json.teams | first).id }}"

    - name: Debug team id
      ansible.builtin.debug:
        msg:
          - "Team trouvée pour team_name='{{ team_name }}'"
          - "team_id={{ grafana_team_id }}"

    # ------------------------------------------------------------------
    # Créer / assurer l'existence de l'utilisateur via module grafana_user
    # ------------------------------------------------------------------

    - name: Ensure Grafana user exists (création/mise à jour)
      community.grafana.grafana_user:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "{{ team_name }} User"
        login: "{{ user_login }}"
        email: "{{ user_email }}"
        password: "{{ user_password }}"
        is_admin: false
        state: present
        validate_certs: false
      register: created_user

    # ------------------------------------------------------------------
    # Ajouter l'utilisateur à la team
    # ------------------------------------------------------------------

    - name: Ensure user is member of team
      community.grafana.grafana_team:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "{{ team_name }}"
        email: ""
        members:
          - "{{ user_login }}"
        state: present
        validate_certs: false

    - name: Display created/updated user info
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "User ajouté à une team Grafana existante"
          - "============================================"
          - "Team: {{ team_name }} (id={{ grafana_team_id }})"
          - "User login: {{ user_login }}"
          - "User email: {{ user_email }}"

    # ------------------------------------------------------------------
    # Dashboard via template Jinja
    # ------------------------------------------------------------------

    - name: Ensure dashboard template exists
      ansible.builtin.stat:
        path: "{{ dashboard_template }}"
      register: dashboard_template_stat

    - name: Fail if dashboard template is missing
      ansible.builtin.fail:
        msg: >
          Le template de dashboard est introuvable :
          {{ dashboard_template }}
          Assure-toi que le fichier 'grafana-automation/templates/dashboard.json.j2'
          est bien présent sur le serveur.
      when: not dashboard_template_stat.stat.exists

    - name: Get datasource influxdb_<company> by name
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/datasources/name/influxdb_{{ company_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: ds_get

    - name: Set datasource facts for dashboard template
      ansible.builtin.set_fact:
        datasource_uid: "{{ ds_get.json.uid }}"
        datasource_id: "{{ ds_get.json.id }}"
        datasource_client_id: >-
          {{
            (ds_get.json.jsonData.clientId
             if (ds_get.json.jsonData is defined and 'clientId' in ds_get.json.jsonData)
             else (company_name ~ '_' ~ user_login))
          }}

    - name: Render company dashboard JSON from template
      ansible.builtin.template:
        src: "{{ dashboard_template }}"
        dest: "{{ campaign_dashboard_json }}"
        mode: "0644"
      when: dashboard_template_stat.stat.exists

    - name: Import company dashboard (idempotent via UID fixe)
      community.grafana.grafana_dashboard:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        state: present
        path: "{{ campaign_dashboard_json }}"
        folder: "{{ company_name }}"
        uid: "{{ campaign_dashboard_uid }}"
        overwrite: true
        validate_certs: false
      register: imported_dashboard
