---
- name: Add a Grafana user to an existing team
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    grafana_url: "{{ lookup('ansible.builtin.env', 'GRAFANA_URL') }}"
    grafana_username: "{{ lookup('ansible.builtin.env', 'GRAFANA_USERNAME') }}"
    grafana_password: "{{ lookup('ansible.builtin.env', 'GRAFANA_PASSWORD') }}"
    grafana_api_token: "{{ lookup('ansible.builtin.env', 'GRAFANA_API_TOKEN') | default('', true) }}"

    # Nom de la team Grafana existante (ex: company1), à passer via --extra-vars
    # team_name: "company1"

    # user_login / user_email / user_password peuvent être surchargés via --extra-vars
    user_login: "{{ user_login_override | default('user_' ~ team_name, true) }}"
    user_email: "{{ user_email_override | default(team_name ~ '@example.com', true) }}"
    user_password: "{{ user_password_override | default('ChangeMe123!', true) }}"

    grafana_auth_headers: >-
      {{
        {'Authorization': 'Bearer ' ~ grafana_api_token}
      }}

  tasks:
    - name: Validate required variable team_name
      ansible.builtin.assert:
        that:
          - team_name is defined
          - team_name | length > 0
        fail_msg: >
          La variable 'team_name' doit être fournie, par exemple :
          ansible-playbook grafana-automation/playbooks/add_grafana_user_to_team.yml
          --extra-vars "team_name=company1"

    - name: Validate Grafana credentials
      ansible.builtin.assert:
        that:
          - grafana_username is defined
          - grafana_password is defined
          - grafana_username | length > 0
          - grafana_password | length > 0
          - grafana_api_token is defined
          - grafana_api_token | length > 0
        fail_msg: >
          GRAFANA_USERNAME, GRAFANA_PASSWORD et GRAFANA_API_TOKEN doivent être définis
          dans l'environnement (.env) et correspondre à un compte / token Admin.

    - name: Check Grafana health
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/health"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: grafana_health
      failed_when: grafana_health.status != 200

    # ------------------------------------------------------------------
    # Récupérer la team existante
    # ------------------------------------------------------------------

    - name: Search existing team by name
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/teams/search?name={{ team_name }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: 200
        validate_certs: false
      register: team_search

    - name: Fail if team not found
      ansible.builtin.fail:
        msg: >
          La team Grafana '{{ team_name }}' est introuvable via /api/teams/search.
          Vérifie le nom dans Grafana.
      when: (team_search.json.teams | default([]) | length) == 0

    - name: Set grafana_team_id fact
      ansible.builtin.set_fact:
        grafana_team_id: "{{ (team_search.json.teams | first).id }}"

    - name: Debug team id
      ansible.builtin.debug:
        msg:
          - "Team trouvée pour team_name='{{ team_name }}'"
          - "team_id={{ grafana_team_id }}"

    # ------------------------------------------------------------------
    # Créer / assurer l'existence de l'utilisateur via API REST
    # ------------------------------------------------------------------

    - name: Lookup existing Grafana user by login
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/users/lookup?loginOrEmail={{ user_login }}"
        method: GET
        headers: "{{ grafana_auth_headers }}"
        status_code: [200, 404]
        validate_certs: false
      register: user_lookup

    - name: Set fact user_exists
      ansible.builtin.set_fact:
        user_exists: "{{ user_lookup.status == 200 }}"

    - name: Debug user lookup
      ansible.builtin.debug:
        msg:
          - "User lookup pour login='{{ user_login }}'"
          - "status={{ user_lookup.status }}"
          - "user_exists={{ user_exists }}"

    - name: Create Grafana user if not exists (via /api/admin/users)
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/admin/users"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ team_name }} User"
          login: "{{ user_login }}"
          email: "{{ user_email }}"
          password: "{{ user_password }}"
        status_code: 200
        validate_certs: false
      register: created_user_resp
      when: not user_exists

    - name: Set grafana_user_id when user was just created
      ansible.builtin.set_fact:
        grafana_user_id: "{{ created_user_resp.json.id }}"
      when: not user_exists

    - name: Set grafana_user_id when user already exists
      ansible.builtin.set_fact:
        grafana_user_id: "{{ user_lookup.json.id }}"
      when: user_exists

    # Optionnel : mise à jour de l'email si l'utilisateur existe déjà
    - name: Update existing Grafana user email if different
      ansible.builtin.uri:
        url: "{{ grafana_url }}/api/users/{{ grafana_user_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ grafana_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          email: "{{ user_email }}"
        status_code: 200
        validate_certs: false
      when:
        - user_exists
        - (user_lookup.json.email | default('')) != user_email

    # ------------------------------------------------------------------
    # Ajouter l'utilisateur à la team
    # ------------------------------------------------------------------

    - name: Ensure user is member of team
      community.grafana.grafana_team:
        url: "{{ grafana_url }}"
        url_username: "{{ grafana_username }}"
        url_password: "{{ grafana_password }}"
        name: "{{ team_name }}"
        email: "{{ user_email }}"
        members:
          - "{{ user_login }}"
        state: present
        validate_certs: false

    - name: Display created/updated user info
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "User ajouté à une team Grafana existante"
          - "============================================"
          - "Team: {{ team_name }} (id={{ grafana_team_id }})"
          - "User login: {{ user_login }}"
          - "User email: {{ user_email }}"
          - "User id: {{ grafana_user_id }}"
